<!DOCTYPE html><html class="theme-next gemini" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.3"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.3"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.3"><link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222"><meta name="keywords" content="Hive,"><link rel="alternate" href="/atom.xml" title="Changfei's Tech Blog" type="application/atom+xml"><meta name="description" content="分区表分区表实际上就是对应一个HDFS文件系统上的独立的文件夹，该文件夹下是该分区所有的数据文件。Hive中的分区就是分目录，把一个大的数据集根据业务需要分割成小的数据集。在查询时通过WHERE子句中的表达式选择查询所需要的指定的分区，这样的查询效率会提高很多。 创建分区表语法hive (default)&amp;gt; create table dept_partition("><meta name="keywords" content="Hive"><meta property="og:type" content="article"><meta property="og:title" content="Hive：7、Hive 分区、分桶"><meta property="og:url" content="http://www.coderfei.com/2018/01/13/hive-7-hive-buck.html"><meta property="og:site_name" content="Changfei&#39;s Tech Blog"><meta property="og:description" content="分区表分区表实际上就是对应一个HDFS文件系统上的独立的文件夹，该文件夹下是该分区所有的数据文件。Hive中的分区就是分目录，把一个大的数据集根据业务需要分割成小的数据集。在查询时通过WHERE子句中的表达式选择查询所需要的指定的分区，这样的查询效率会提高很多。 创建分区表语法hive (default)&amp;gt; create table dept_partition("><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="http://www.coderfei.com/2018/01/13/hive-7-hive-buck/hive-4.png"><meta property="og:image" content="http://www.coderfei.com/2018/01/13/hive-7-hive-buck/hive-5.png"><meta property="og:image" content="http://www.coderfei.com/2018/01/13/hive-7-hive-buck/hive-1.png"><meta property="og:image" content="http://www.coderfei.com/2018/01/13/hive-7-hive-buck/hive-2.png"><meta property="og:image" content="http://www.coderfei.com/2018/01/13/hive-7-hive-buck/hive-3.png"><meta property="og:updated_time" content="2018-11-20T02:07:46.704Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Hive：7、Hive 分区、分桶"><meta name="twitter:description" content="分区表分区表实际上就是对应一个HDFS文件系统上的独立的文件夹，该文件夹下是该分区所有的数据文件。Hive中的分区就是分目录，把一个大的数据集根据业务需要分割成小的数据集。在查询时通过WHERE子句中的表达式选择查询所需要的指定的分区，这样的查询效率会提高很多。 创建分区表语法hive (default)&amp;gt; create table dept_partition("><meta name="twitter:image" content="http://www.coderfei.com/2018/01/13/hive-7-hive-buck/hive-4.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"5.1.3",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://www.coderfei.com/2018/01/13/hive-7-hive-buck.html"><title>Hive：7、Hive 分区、分桶 | Changfei's Tech Blog</title></head><body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Changfei's Tech Blog</span><span class="logo-line-after"><i></i></span></a></div><h1 class="site-subtitle" itemprop="description">在纷杂的世界安静的写代码</h1></div><div class="site-nav-toggle"> <button><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br> 首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br> 归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br> 标签</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br> 关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.coderfei.com/2018/01/13/hive-7-hive-buck.html"><span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoderF"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.png"></span><span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="Changfei's Tech Blog"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">Hive：7、Hive 分区、分桶</h2><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-13T13:16:30+08:00">2018-01-13</time></span> <span class="post-category"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Hive/" itemprop="url" rel="index"><span itemprop="name">Hive</span></a></span></span> <span id="/2018/01/13/hive-7-hive-buck.html" class="leancloud_visitors" data-flag-title="Hive：7、Hive 分区、分桶"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数&#58;</span><span class="leancloud-visitors-count"></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">1,649</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">8</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="分区表"><a href="#分区表" class="headerlink" title="分区表"></a>分区表</h2><p>分区表实际上就是对应一个HDFS文件系统上的独立的文件夹，该文件夹下是该分区所有的数据文件。Hive中的分区就是分目录，把一个大的数据集根据业务需要分割成小的数据集。在查询时通过WHERE子句中的表达式选择查询所需要的指定的分区，这样的查询效率会提高很多。</p><h3 id="创建分区表语法"><a href="#创建分区表语法" class="headerlink" title="创建分区表语法"></a>创建分区表语法</h3><pre><code>hive (default)&gt; create table dept_partition(
               deptno int, dname string, loc string
               )
               partitioned by (month string)
               row format delimited fields terminated by &#39;\t&#39;;
</code></pre><h3 id="加载数据到分区表中"><a href="#加载数据到分区表中" class="headerlink" title="加载数据到分区表中"></a>加载数据到分区表中</h3><pre><code>hive (default)&gt; load data local inpath &#39;/opt/module/datas/dept.txt&#39; into table default.dept_partition partition(month=&#39;201709&#39;);
hive (default)&gt; load data local inpath &#39;/opt/module/datas/dept.txt&#39; into table default.dept_partition partition(month=&#39;201708&#39;);
hive (default)&gt; load data local inpath &#39;/opt/module/datas/dept.txt&#39; into table default.dept_partition partition(month=&#39;201707&#39;);
</code></pre><img src="/2018/01/13/hive-7-hive-buck/hive-4.png"> <img src="/2018/01/13/hive-7-hive-buck/hive-5.png"><a id="more"></a><h3 id="查询分区表中数据"><a href="#查询分区表中数据" class="headerlink" title="查询分区表中数据"></a>查询分区表中数据</h3><p>单分区查询</p><pre><code>hive (default)&gt; select * from dept_partition where month=&#39;201709&#39;;

OK
10      ACCOUNTING      NEWYORK 201709
10      ACCOUNTING      NEWYORK 201709
10      ACCOUNTING      NEWYORK 201709
20      RESEARCH        DALLAS  201709
20      RESEARCH        DALLAS  201709
20      RESEARCH        DALLAS  201709
30      OPERATIONS      BOSTON  201709
30      OPERATIONS      BOSTON  201709
30      OPERATIONS      BOSTON  201709
Time taken: 0.362 seconds, Fetched: 9 row(s)
</code></pre><p>多分区联合查询</p><pre><code>hive (default)&gt; select * from dept_partition where month=&#39;201709&#39; union all select * from dept_partition where month=&#39;201708&#39;;

OK
10      ACCOUNTING      NEWYORK 201709
10      ACCOUNTING      NEWYORK 201709
10      ACCOUNTING      NEWYORK 201709
20      RESEARCH        DALLAS  201709
20      RESEARCH        DALLAS  201709
20      RESEARCH        DALLAS  201709
30      OPERATIONS      BOSTON  201709
30      OPERATIONS      BOSTON  201709
30      OPERATIONS      BOSTON  201709
10      ACCOUNTING      NEWYORK 201708
10      ACCOUNTING      NEWYORK 201708
10      ACCOUNTING      NEWYORK 201708
20      RESEARCH        DALLAS  201708
20      RESEARCH        DALLAS  201708
20      RESEARCH        DALLAS  201708
30      OPERATIONS      BOSTON  201708
30      OPERATIONS      BOSTON  201708
30      OPERATIONS      BOSTON  201708
Time taken: 30.91 seconds, Fetched: 18 row(s)
</code></pre><h3 id="增加分区"><a href="#增加分区" class="headerlink" title="增加分区"></a>增加分区</h3><p>增加单个分区</p><pre><code>hive (default)&gt; alter table dept_partition add partition(month=&#39;201706&#39;);
</code></pre><p>同时创建多个分区</p><pre><code>hive (default)&gt;  alter table dept_partition add partition(month=&#39;201705&#39;) partition(month=&#39;201704&#39;);
</code></pre><h3 id="删除分区"><a href="#删除分区" class="headerlink" title="删除分区"></a>删除分区</h3><p>删除单个分区</p><pre><code>hive (default)&gt; alter table dept_partition drop partition (month=&#39;201704&#39;);
</code></pre><p>同时删除多个分区</p><pre><code>hive (default)&gt; alter table dept_partition drop partition (month=&#39;201705&#39;), partition (month=&#39;201706&#39;);
</code></pre><h3 id="查看分区表有多少分区"><a href="#查看分区表有多少分区" class="headerlink" title="查看分区表有多少分区"></a>查看分区表有多少分区</h3><pre><code>hive&gt;show partitions dept_partition;
</code></pre><h3 id="查看分区表结构"><a href="#查看分区表结构" class="headerlink" title="查看分区表结构"></a>查看分区表结构</h3><pre><code>hive (default)&gt; desc formatted dept_partition;
OK
col_name        data_type       comment
# col_name              data_type               comment             

deptno                  int                                         
dname                   string                                      
loc                     string                                      

# Partition Information          
# col_name              data_type               comment             

month                   string                                      

# Detailed Table Information             
Database:               default                  
Owner:                  root                     
CreateTime:             Wed Jun 20 13:53:42 CST 2018     
LastAccessTime:         UNKNOWN                  
Protect Mode:           None                     
Retention:              0                        
Location:               hdfs://mycluster/user/hive/warehouse/dept_partition      
Table Type:             MANAGED_TABLE            
Table Parameters:                
        transient_lastDdlTime   1529474022          

# Storage Information            
SerDe Library:          org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe       
InputFormat:            org.apache.hadoop.mapred.TextInputFormat         
OutputFormat:           org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat       
Compressed:             No                       
Num Buckets:            -1                       
Bucket Columns:         []                       
Sort Columns:           []                       
Storage Desc Params:             
        field.delim             \t                  
        serialization.format    \t                  
Time taken: 0.09 seconds, Fetched: 34 row(s)
</code></pre><h2 id="分区表注意事项"><a href="#分区表注意事项" class="headerlink" title="分区表注意事项"></a>分区表注意事项</h2><h3 id="创建二级分区表"><a href="#创建二级分区表" class="headerlink" title="创建二级分区表"></a>创建二级分区表</h3><pre><code>hive (default)&gt; create table dept_partition2(
               deptno int, dname string, loc string
               )
               partitioned by (month string, day string)
               row format delimited fields terminated by &#39;\t&#39;;
</code></pre><h3 id="正常的加载数据"><a href="#正常的加载数据" class="headerlink" title="正常的加载数据"></a>正常的加载数据</h3><p>加载数据到二级分区表中</p><pre><code>hive (default)&gt; load data local inpath &#39;/opt/module/datas/dept.txt&#39; into table default.dept_partition2 partition(month=&#39;201709&#39;, day=&#39;13&#39;);
</code></pre><p>查询分区数据</p><pre><code>hive (default)&gt; select * from dept_partition2 where month=&#39;201709&#39; and day=&#39;13&#39;;
</code></pre><h3 id="把数据直接上传到分区目录上，让分区表和数据产生关联的两种方式"><a href="#把数据直接上传到分区目录上，让分区表和数据产生关联的两种方式" class="headerlink" title="把数据直接上传到分区目录上，让分区表和数据产生关联的两种方式"></a>把数据直接上传到分区目录上，让分区表和数据产生关联的两种方式</h3><p>方式一：上传数据后修复</p><pre><code>hive (default)&gt; dfs -mkdir -p /user/hive/warehouse/dept_partition2/month=201709/day=12;
hive (default)&gt; dfs -put /opt/module/datas/dept.txt  /user/hive/warehouse/dept_partition2/month=201709/day=12;
</code></pre><p>查询数据（查询不到刚上传的数据）</p><pre><code>hive (default)&gt; select * from dept_partition2 where month=&#39;201709&#39; and day=&#39;12&#39;;
</code></pre><p>执行修复命令</p><pre><code>hive&gt;msck repair table dept_partition2;
</code></pre><p>再次查询数据</p><pre><code>hive (default)&gt; select * from dept_partition2 where month=&#39;201709&#39; and day=&#39;12&#39;;
</code></pre><p>方式二：上传数据后添加分区</p><pre><code>hive (default)&gt; dfs -mkdir -p /user/hive/warehouse/dept_partition2/month=201709/day=11;
hive (default)&gt; dfs -put /opt/module/datas/dept.txt  /user/hive/warehouse/dept_partition2/month=201709/day=11;
</code></pre><p>执行添加分区</p><pre><code>hive (default)&gt; alter table dept_partition2 add partition(month=&#39;201709&#39;, day=&#39;11&#39;);
</code></pre><p>查询数据</p><pre><code>hive (default)&gt; select * from dept_partition2 where month=&#39;201709&#39; and day=&#39;11&#39;;
</code></pre><h2 id="分桶表"><a href="#分桶表" class="headerlink" title="分桶表"></a>分桶表</h2><font color="red">分区针对的是数据的存储路径；分桶针对的是数据文件。</font><p>分区提供一个隔离数据和优化查询的便利方式。不过，并非所有的数据集都可形成合理的分区，特别是之前所提到过的要确定合适的划分大小这个疑虑。</p><p>分桶是将数据集分解成更容易管理的若干部分的另一个技术。</p><h3 id="创建分桶表，通过直接导入数据文件的方式"><a href="#创建分桶表，通过直接导入数据文件的方式" class="headerlink" title="创建分桶表，通过直接导入数据文件的方式"></a>创建分桶表，通过直接导入数据文件的方式</h3><p>创建分桶表</p><pre><code>hive&gt; create table stu_buck(id int, name string)
clustered by(id) 
into 4 buckets
row format delimited fields terminated by &#39;\t&#39;;
</code></pre><p>查看表结构</p><pre><code>hive&gt; desc formatted stu_buck;
Num Buckets:            4 
</code></pre><p>导入数据到分桶表中</p><pre><code>hive&gt; load data local inpath &#39;/opt/module/datas/student.txt&#39; into table stu_buck;
</code></pre><p>查看创建的分桶表中是否分成4个桶</p> <img src="/2018/01/13/hive-7-hive-buck/hive-1.png"><p>发现并没有分成4个桶。是什么原因呢？</p><h3 id="创建分桶表，数据通过子查询的方式导入"><a href="#创建分桶表，数据通过子查询的方式导入" class="headerlink" title="创建分桶表，数据通过子查询的方式导入"></a>创建分桶表，数据通过子查询的方式导入</h3><p>先建一个普通的stu表</p><pre><code>hive&gt; create table stu(id int, name string) row format delimited fields terminated by &#39;\t&#39;;
</code></pre><p>向普通的stu表中导入数据</p><pre><code>hive&gt; load data local inpath &#39;/opt/module/datas/student.txt&#39; into table stu;
</code></pre><p>清空stu_buck表中数据</p><pre><code>hive&gt; truncate table stu_buck;
hive&gt; select * from stu_buck;
</code></pre><p>导入数据到分桶表，通过子查询的方式</p><pre><code>hive&gt; insert into table stu_buck select id, name from stu cluster by(id);
</code></pre><p>发现还是只有一个分桶</p> <img src="/2018/01/13/hive-7-hive-buck/hive-2.png"><p>需要设置一个属性</p><pre><code>hive&gt; set hive.enforce.bucketing=true;
hive&gt; set mapreduce.job.reduces=-1;
hive&gt; insert into table stu_buck select id, name from stu cluster by(id);
</code></pre><p>查看创建的分桶表中是否分成4个桶</p> <img src="/2018/01/13/hive-7-hive-buck/hive-3.png"><h3 id="分桶抽样查询"><a href="#分桶抽样查询" class="headerlink" title="分桶抽样查询"></a>分桶抽样查询</h3><p>对于非常大的数据集，有时用户需要使用的是一个具有代表性的查询结果而不是全部结果。Hive可以通过对表进行抽样来满足这个需求。</p><p>查询表stu_buck中的数据</p><pre><code>hive&gt; select * from stu_buck TABLESAMPLE(bucket 1 out of 4 on id);
</code></pre><font color="red">注：tablesample是抽样语句，语法：TABLESAMPLE(BUCKET x OUT OF y)</font><p>y必须是table总bucket数的倍数或者因子。</p><p>hive根据y的大小，决定抽样的比例。</p><p>例如，table总共分了4份，当y=2时，抽取(4/2=)2个bucket的数据，当y=8时，抽取(4/8=)1/2个bucket的数据。</p><p>x表示从哪个bucket开始抽取。</p><p>例如，table总bucket数为4，tablesample(bucket 4 out of 4)，表示总共抽取（4/4=）1个bucket的数据，抽取第4个bucket的数据。</p><h3 id="数据块抽样"><a href="#数据块抽样" class="headerlink" title="数据块抽样"></a>数据块抽样</h3><p>Hive提供了另外一种按照百分比进行抽样的方式，这种事基于行数的，按照输入路径下的数据块百分比进行的抽样。</p><pre><code>hive&gt; select * from stu tablesample(0.1 percent);
</code></pre><font color="red">注：这种抽样方式不一定适用于所有的文件格式。另外，这种抽样的最小抽样单元是一个HDFS数据块。因此，如果表的数据大小小于普通的块大小128M的话，那么将会返回所有行。</font><p>基于百分比的抽样方式提供了一个变量，用于控制基于数据块的调优的种子信息。</p><pre><code>&lt;property&gt;
    &lt;name&gt;hive.sample.seednumber&lt;/name&gt;
    &lt;value&gt;0&lt;/value&gt;
&lt;/property&gt;
</code></pre></div><div><div style="padding:10px 0;margin:20px auto;width:90%;text-align:center"><div>您的支持将鼓励我继续创作！</div> <button id="rewardButton" disable="enable" onclick='var qr=document.getElementById("QR");"none"===qr.style.display?qr.style.display="block":qr.style.display="none"'> <span>打赏</span></button><div id="QR" style="display:none"><div id="wechat" style="display:inline-block"> <img id="wechat_qr" src="/images/wechatpay.png" alt="CoderF 微信支付"><p>微信支付</p></div><div id="alipay" style="display:inline-block"> <img id="alipay_qr" src="/images/alipay.png" alt="CoderF 支付宝"><p>支付宝</p></div></div></div></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Hive/" rel="tag"><i class="fa fa-tag"></i> Hive</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/01/12/hive-6-hive-import-export.html" rel="next" title="Hive：6、Hive ImportExport"><i class="fa fa-chevron-left"></i> Hive：6、Hive ImportExport</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2018/01/14/hive-8-hive-func.html" rel="prev" title="Hive：8、Hive 函数">Hive：8、Hive 函数<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"><div class="bdsharebuttonbox"><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a><a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a><a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a><a href="#" class="bds_more" data-cmd="more"></a><a class="bds_count" data-cmd="count"></a></div><script>window._bd_share_config={common:{bdText:"",bdMini:"2",bdMiniList:!1,bdPic:""},share:{bdSize:"16",bdStyle:"0"},image:{viewList:["tsina","douban","sqq","qzone","weixin","twi","fbook"],viewText:"分享到：",viewSize:"16"}}</script><script>with(document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="/static/api/js/share.js?cdnversion="+~(-new Date/36e5)</script></div></div></div><div class="comments" id="comments"><div id="vcomments"></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="CoderF"><p class="site-author-name" itemprop="name">CoderF</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">69</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/index.html"><span class="site-state-item-count">12</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">12</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://www.jianshu.com/u/cf9e217dcf5c" target="_blank" title="简书"><i class="fa fa-fw fa-heartbeat"></i> 简书</a></span><span class="links-of-author-item"><a href="https://github.com/wangchangfei" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://weibo.com/u/5870480318?is_all=1" target="_blank" title="微博"><i class="fa fa-fw fa-weibo"></i> 微博</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#分区表"><span class="nav-number">1.</span> <span class="nav-text">分区表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建分区表语法"><span class="nav-number">1.1.</span> <span class="nav-text">创建分区表语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#加载数据到分区表中"><span class="nav-number">1.2.</span> <span class="nav-text">加载数据到分区表中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查询分区表中数据"><span class="nav-number">1.3.</span> <span class="nav-text">查询分区表中数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#增加分区"><span class="nav-number">1.4.</span> <span class="nav-text">增加分区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除分区"><span class="nav-number">1.5.</span> <span class="nav-text">删除分区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看分区表有多少分区"><span class="nav-number">1.6.</span> <span class="nav-text">查看分区表有多少分区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看分区表结构"><span class="nav-number">1.7.</span> <span class="nav-text">查看分区表结构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分区表注意事项"><span class="nav-number">2.</span> <span class="nav-text">分区表注意事项</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建二级分区表"><span class="nav-number">2.1.</span> <span class="nav-text">创建二级分区表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#正常的加载数据"><span class="nav-number">2.2.</span> <span class="nav-text">正常的加载数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#把数据直接上传到分区目录上，让分区表和数据产生关联的两种方式"><span class="nav-number">2.3.</span> <span class="nav-text">把数据直接上传到分区目录上，让分区表和数据产生关联的两种方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分桶表"><span class="nav-number">3.</span> <span class="nav-text">分桶表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建分桶表，通过直接导入数据文件的方式"><span class="nav-number">3.1.</span> <span class="nav-text">创建分桶表，通过直接导入数据文件的方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建分桶表，数据通过子查询的方式导入"><span class="nav-number">3.2.</span> <span class="nav-text">创建分桶表，数据通过子查询的方式导入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分桶抽样查询"><span class="nav-number">3.3.</span> <span class="nav-text">分桶抽样查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据块抽样"><span class="nav-number">3.4.</span> <span class="nav-text">数据块抽样</span></a></li></ol></li></ol></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2018</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">CoderF</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">91.1k</span></div><link rel="stylesheet" href="//cdn.bootcss.com/highlight.js/9.2.0/styles/solarized-light.min.css"><script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.4.0/languages/scala.min.js"></script><script>hljs.initHighlightingOnLoad()</script></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.3"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine@1.1.4/dist/Valine.min.js"></script><script type="text/javascript">new Valine({av:AV,el:"#vcomments",verify:!1,notify:!1,app_id:"x8P6mpIr7TWIoaIwTFLtvUjw-gzGzoHsz",app_key:"PkMk480kBPrRXPvH5GF36VpI",placeholder:"说点什么吧！"})</script><script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script><script>AV.initialize("x8P6mpIr7TWIoaIwTFLtvUjw-gzGzoHsz","PkMk480kBPrRXPvH5GF36VpI")</script><script>function showTime(e){var t=new AV.Query(e),c=[],u=$(".leancloud_visitors");u.each(function(){c.push($(this).attr("id").trim())}),t.containedIn("url",c),t.find().done(function(e){var t=".leancloud-visitors-count";if(0!==e.length){for(var n=0;n<e.length;n++){var o=e[n],i=o.get("url"),s=o.get("time"),r=document.getElementById(i);$(r).find(t).text(s)}for(n=0;n<c.length;n++){i=c[n],r=document.getElementById(i);var l=$(r).find(t);""==l.text()&&l.text(0)}}else u.find(t).text(0)}).fail(function(e,t){console.log("Error: "+t.code+" "+t.message)})}function addCount(i){var e=$(".leancloud_visitors"),s=e.attr("id").trim(),r=e.attr("data-flag-title").trim(),t=new AV.Query(i);t.equalTo("url",s),t.find({success:function(e){if(0<e.length){var t=e[0];t.fetchWhenSave(!0),t.increment("time"),t.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to save Visitor num, with error message: "+t.message)}})}else{var n=new i,o=new AV.ACL;o.setPublicReadAccess(!0),o.setPublicWriteAccess(!0),n.setACL(o),n.set("title",r),n.set("url",s),n.set("time",1),n.save(null,{success:function(e){$(document.getElementById(s)).find(".leancloud-visitors-count").text(e.get("time"))},error:function(e,t){console.log("Failed to create")}})}},error:function(e){console.log("Error:"+e.code+" "+e.message)}})}$(function(){var e=AV.Object.extend("Counter");1==$(".leancloud_visitors").length?addCount(e):1<$(".post-title-link").length&&showTime(e)})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script></body></html><script type="text/javascript" src="/js/src/love.js"></script>